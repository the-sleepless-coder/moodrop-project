# 향수 제조 로봇 시스템

다이어그램에 따라 모듈화된 향수 제조 로봇 시스템입니다.

## 시스템 아키텍처

### 모듈 구성
- **main.c**: 메인 제어 모듈 - 전체 시스템 통합 관리
- **MQTT.c**: MQTT 통신 모듈 - 메시지 송수신 및 파싱
- **servo.c**: 서보 모터 제어 모듈 - 밸브 및 플레이트 회전 제어
- **log.c**: 로그 기록 모듈 - 시스템 동작 기록 및 관리
- **LED.c**: LED 제어 모듈 - 시각적 피드백 및 신호 전송
- **BaseStorage.c**: 베이스 스토리지 모듈 - 원료 용량 관리

### 데이터 흐름
1. **MQTT** → **Data**: 메시지 수신 및 파싱
2. **Data** → **Servo**: 레시피에 따른 서보 제어
3. **Servo** → **LED**: 모터 동작 신호 전송
4. **LED** → **Log**: 시각적 피드백 기록
5. **Log** → **BaseStorage**: 시스템 상태 업데이트
6. **BaseStorage** → **MQTT**: 원료 상태 확인 및 업데이트

## 주요 기능

### MQTT 모듈
- 메시지 수신 및 파싱
- 레시피 정보 처리
- 상태 요청 응답
- 신호 전송

### 서보 모듈
- 밸브 서보 제어 (0-180도)
- 플레이트 회전 제어 (0-360도)
- 레시피 스텝 실행
- 안전한 동작 제어

### 로그 모듈
- MQTT 송수신 기록
- 모터 동작 기록
- 제조 진행 상황 기록
- 원료 잔량 확인 기록
- 시스템 상태 모니터링
- 로그 파일 로테이션

### LED 모듈
- 시각적 피드백 제공
- 제조 상태 표시
- 에러 신호 표시
- 다양한 패턴 지원

### 베이스 스토리지 모듈
- 원료 용량 관리
- 제조 가능 여부 확인
- 원료 사용량 추적
- 용량 임계값 관리

## 컴파일 및 실행

### 빌드
```bash
make
```

### 실행
```bash
make run
```

### 정리
```bash
make clean
```

### 디버그 모드
```bash
make debug
```

## 시스템 요구사항

### 하드웨어
- Raspberry Pi 또는 유사한 Linux 기반 시스템
- 서보 모터 2개 (밸브, 플레이트 회전용)
- LED 1개 (상태 표시용)
- GPIO 핀 지원

### 소프트웨어
- GCC 컴파일러
- Linux 시스템
- MQTT 브로커 (예: Mosquitto)

## 설정

### MQTT 설정
- 브로커 주소: localhost
- 포트: 1883
- 클라이언트 ID: perfume_robot

### GPIO 핀 설정
- LED: GPIO 23
- 밸브 서보: GPIO 18
- 플레이트 서보: GPIO 19

## 로그 파일

로그는 `/var/log/perfume_robot.log`에 저장됩니다.
- 로그 레벨: ERROR, MQTT, SERVO, MANUFACTURING, MAINTENANCE, LED
- 자동 로테이션 (10MB 초과 시)
- 타임스탬프 포함

## 원료 관리

### 기본 원료
- 베이스 오일: 1000ml
- 알코올: 2000ml
- 에센셜 오일 (라벤더, 로즈, 자스민, 바닐라, 시트러스, 우드): 각 500ml

### 용량 관리
- 실시간 용량 추적
- 임계값 경고
- 자동 보충 알림

## 제조 프로세스

1. **레시피 수신**: MQTT를 통해 레시피 정보 수신
2. **원료 확인**: 제조 가능 여부 확인
3. **제조 시작**: 서보 모터를 통한 정확한 원료 분사
4. **진행 모니터링**: 실시간 제조 상황 기록
5. **완료 처리**: 원료 용량 갱신 및 완료 신호 전송

## 에러 처리

- 서보 모터 동작 실패 감지
- 원료 부족 상황 처리
- MQTT 연결 오류 처리
- 시스템 상태 모니터링

## 확장 가능성

- 새로운 원료 추가
- 복잡한 레시피 지원
- 웹 인터페이스 연동
- 원격 모니터링 시스템
- 데이터베이스 연동